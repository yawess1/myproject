{% extends "base.html" %}

{% block title %}Manage Food Categories{% endblock %}

{% block content %}
<section class="py-5">
  <div class="container">
    <h2>{{ restaurant_name }} - Category Management</h2>

    <div id="crudAlert" class="alert alert-dismissible fade show mt-2 d-none" role="alert">
      <span id="crudAlertMsg"></span>
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <table class="table mt-4">
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="categoryTableBody">
        <!-- Dynamic rows will go here -->
      </tbody>
    </table>

    <button class="btn btn-primary w-100 mb-4" id="addCatBtn">Add New Category</button>

    <!-- Modal -->
    <div class="modal fade" id="crudModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <form id="crudForm">
            <div class="modal-header">
              <h5 class="modal-title" id="crudModalLabel">Add</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
              <div class="mb-3">
                <label for="catName" class="form-label">Category Name</label>
                <input type="text" class="form-control" id="catName" required>
              </div>
              <div class="mb-3">
                <label for="catDesc" class="form-label">Description</label>
                <textarea class="form-control" id="catDesc" rows="2"></textarea>
              </div>
            </div>

            <input type="hidden" id="rowId">

            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-primary" id="saveBtn">Save</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <template id="catRowTmpl">
      <tr>
        <td class="cat-name fw-semibold"></td>
        <td class="cat-desc"></td>
        <td>
          <button class="btn btn-sm btn-primary me-1 edit-row">Edit</button>
          <button class="btn btn-sm btn-danger del-row">Delete</button>
        </td>
      </tr>
    </template>
  </div>
</section>

<script type="module">
  const API = {
    category: "/myproject/api/categories/"
  };

  const RESTAURANT_ID = "{{ restaurant_id }}";

  const CSRF = "{{ csrf_token }}";
  const modal = bootstrap.Modal.getOrCreateInstance(crudModal);

  const catName = document.getElementById("catName");
  const catDesc = document.getElementById("catDesc");
  const rowId = document.getElementById("rowId");

  function alertMsg(txt, ok = true) {
    crudAlertMsg.textContent = txt;
    crudAlert.classList.remove("d-none", "alert-success", "alert-danger");
    crudAlert.classList.add(ok ? "alert-success" : "alert-danger");
    setTimeout(() => crudAlert.classList.add("d-none"), 4000);
  }

  function opts(method, body = null) {
    return {
      method,
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": CSRF,
      },
      body: body ? JSON.stringify(body) : null,
    };
  }

  function openModal(data = null) {
    rowId.value = data?.id ?? "";
    crudModalLabel.textContent = data ? "Edit Category" : "Add Category";
    crudForm.reset();
    if (data) {
      catName.value = data.name;
      catDesc.value = data.description ?? "";
    }
    modal.show();
  }

  addCatBtn.onclick = () => openModal();

  crudForm.onsubmit = async (e) => {
    e.preventDefault();
    const pk = rowId.value;
    const url = pk ? API.category + pk + "/" : API.category;
    const method = pk ? "PUT" : "POST";

    const body = {
      name: catName.value,
      description: catDesc.value,
      restaurant_id: RESTAURANT_ID
    };

    try {
      const res = await fetch(url, opts(method, body));
      if (!res.ok) throw Error();
      const data = await res.json();

      if (pk) {
        const tr = document.querySelector(`tr[data-id="${pk}"]`);
        tr.querySelector(".cat-name").textContent = data.name;
        tr.querySelector(".cat-desc").textContent = data.description;
      } else {
        const row = catRowTmpl.content.cloneNode(true);
        row.firstElementChild.dataset.id = data.id;
        row.querySelector(".cat-name").textContent = data.name;
        row.querySelector(".cat-desc").textContent = data.description;
        categoryTableBody.appendChild(row);
      }

      modal.hide();
      alertMsg("Saved ✔");
    } catch {
      alertMsg("Save failed", false);
    }
  };

  document.addEventListener("click", async (e) => {
    if (e.target.classList.contains("edit-row")) {
      const tr = e.target.closest("tr");
      const id = tr.dataset.id;
      const res = await fetch(API.category + id + "/");
      const data = await res.json();
      openModal(data);
    }

    if (e.target.classList.contains("del-row")) {
      if (!confirm("Really delete?")) return;
      const tr = e.target.closest("tr");
      const id = tr.dataset.id;
      try {
        const res = await fetch(API.category + id + "/", opts("DELETE"));
        if (!res.ok) throw Error();
        tr.remove();
        alertMsg("Deleted ✔");
      } catch {
        alertMsg("Delete failed", false);
      }
    }
  });

  // Load initial categories
  window.onload = async () => {
    const res = await fetch(API.category + `?restaurant_id=${RESTAURANT_ID}`);
    const categories = await res.json();
    categories.forEach((cat) => {
      const row = catRowTmpl.content.cloneNode(true);
      row.firstElementChild.dataset.id = cat.id;
      row.querySelector(".cat-name").textContent = cat.name;
      row.querySelector(".cat-desc").textContent = cat.description;
      categoryTableBody.appendChild(row);
    });
  };
</script>
{% endblock %}
