{% extends "base.html" %}

{% block title %}Menu Management{% endblock %}

{% block content %}
<section class="py-5">
  <div class="container">
    <h2>{{ restaurant_name }} - Menu Management</h2>
    <p><strong>Contact:</strong> {{ email }}</p>
    <p><strong>Address:</strong> {{ restaurant_address }}</p>

    <div id="crudAlert" class="alert alert-dismissible fade show mt-2 d-none" role="alert">
      <span id="crudAlertMsg"></span>
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <h3>Menu Items</h3>
    <table class="table">
      <thead>
        <tr>
          <th>Image</th>
          <th>Name</th>
          <th>Category</th>
          <th>Description</th>
          <th>Price</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="menuTableBody">
        {% for item in menu_items %}
        <tr data-id="{{ item.id }}">
          <td class="m-image">
            {% if item.image %}
              <img src="{{ item.image.url }}" alt="{{ item.name }}">
            {% endif %}
          </td>
          <td class="m-name fw-semibold">{{ item.name }}</td>
          <td class="m-category">
            {% if item.category %}
              {{ item.category.name }}
            {% else %}
              Uncategorized
            {% endif %}
          </td>
          <td class="m-description">{{ item.description }}</td>
          <td class="m-price">${{ item.price }}</td>
          <td>
            <button class="btn btn-sm btn-primary me-1 edit-row">Edit</button>
            <button class="btn btn-sm btn-danger del-row">Delete</button>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="5">
            <em>No menu items yet.</em>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <button class="btn btn-primary w-100 mb-4" id="addMenuBtn">Add Menu Item</button>

    <!-- Modal for Create/Edit -->
    <div class="modal fade" id="crudModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <form id="crudForm">
            <div class="modal-header">
              <h5 class="modal-title" id="crudModalLabel">Add Menu Item</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label for="menuName" class="form-label">Name</label>
                <input type="text" class="form-control" id="menuName" required>
              </div>

              <div class="mb-3">
                <label for="menuCategory" class="form-label">Category</label>
                <select class="form-select" id="menuCategory" required>
                  {% for cat in food_categories %}
                    <option value="{{ cat.id }}">{{ cat.name }}</option>
                  {% endfor %}
                </select>
              </div>

              <div class="mb-3">
                <label for="menuImage" class="form-label">Image</label>
                <input type="file" class="form-control" id="menuImage" accept="image/*">
              </div>

              <div class="mb-3">
                <label for="menuDescription" class="form-label">Description</label>
                <textarea class="form-control" id="menuDescription"></textarea>
              </div>

              <div class="mb-3">
                <label for="menuPrice" class="form-label">Price</label>
                <input type="number" step="0.01" class="form-control" id="menuPrice" required>
              </div>
            </div>
            <input type="hidden" id="rowId">
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-primary">Save</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Template Row -->
    <template id="menuRowTmpl">
      <tr>
        <td class="m-image"></td>
        <td class="m-name fw-semibold"></td>
        <td class="m-category"></td>
        <td class="m-description"></td>
        <td class="m-price"></td>
        <td>
          <button class="btn btn-sm btn-primary me-1 edit-row">Edit</button>
          <button class="btn btn-sm btn-danger del-row">Delete</button>
        </td>
      </tr>
    </template>
  </div>
</section>

<script type="module">
  const API = {
    menu: '/myproject/api/menu/',
  };
  const CSRF = "{{ csrf_token }}";

  const modal = bootstrap.Modal.getOrCreateInstance(crudModal);
  const alertBox = document.getElementById("crudAlert");
  const alertMsg = document.getElementById("crudAlertMsg");
  const RESTAURANT_ID = "{{ restaurant_id }}";

  function showAlert(text, ok = true) {
    alertMsg.textContent = text;
    alertBox.classList.remove("d-none", "alert-success", "alert-danger");
    alertBox.classList.add(ok ? "alert-success" : "alert-danger");
    setTimeout(() => alertBox.classList.add("d-none"), 4000);
  }

  function apiOptions(method, body = null) {
    return {
      method,
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': CSRF
      },
      body: body ? JSON.stringify(body) : null
    };
  }
  async function loadCategories() {
    try {
        const res = await fetch(`/myproject/api/categories/?restaurant_id=${RESTAURANT_ID}`);
        if (!res.ok) throw Error();
        const categories = await res.json();

        const select = document.getElementById("menuCategory");
        select.innerHTML = ''; // Clear old options

        categories.forEach(cat => {
        const option = document.createElement("option");
        option.value = cat.id;
        option.textContent = cat.name;
        select.appendChild(option);
        });
    } catch {
        showAlert("Failed to load categories ❌", false);
    }
  }


async function openModal(data = null) {
    await loadCategories();

    rowId.value = data?.id ?? '';
    crudModalLabel.textContent = data ? 'Edit Menu Item' : 'Add Menu Item';
    crudForm.reset();

    if (data) {
      menuName.value = data.name;
      if (data.category) {
        menuCategory.value = data.category.id;
      }
      menuDescription.value = data.description ?? '';
      menuPrice.value = data.price;
    }

    modal.show();
  }

  addMenuBtn.onclick = () => openModal();

  crudForm.onsubmit = async (e) => {
    e.preventDefault();

    const pk = rowId.value;
    const url = pk ? API.menu + pk + '/' : API.menu;
    const method = pk ? 'PUT' : 'POST';

    const formData = new FormData();
    formData.append('name', menuName.value);
    formData.append('category_id', menuCategory.value);
    formData.append('description', menuDescription.value);
    formData.append('price', menuPrice.value);
    formData.append('restaurant_id', RESTAURANT_ID);


    if (menuImage.files[0]) {
      formData.append('image', menuImage.files[0]);
    }

    try {
      const res = await fetch(url, {
        method: method,
        headers: {
          'X-CSRFToken': CSRF
        },
        body: formData,
        credentials: 'same-origin'
      });
      console.log("res.ok:", res.ok, "status:", res.status);
      const data = await res.json();
      console.log("data:", data);

      if (!res.ok) {
        showAlert("Save failed ❌", false);
        return;
      }

      if (pk) {
        const tr = document.querySelector(`tr[data-id="${pk}"]`);
        if (tr) {
          const nameCell = tr.querySelector('.m-name');
          if (nameCell) nameCell.textContent = data.name;
          const catCell = tr.querySelector('.m-category');
          if (catCell) catCell.textContent = data.category && data.category.name ? data.category.name : "Uncategorized";
          const descCell = tr.querySelector('.m-description');
          if (descCell) descCell.textContent = data.description;
          const priceCell = tr.querySelector('.m-price');
          if (priceCell) priceCell.textContent = `$${data.price}`;
        }
      } else {
        const row = menuRowTmpl.content.cloneNode(true);
        row.firstElementChild.dataset.id = data.id;
        const imageCell = row.querySelector('.m-image');
        if (data.image_url) {   
          imageCell.innerHTML = `<img src="${data.image_url}" alt="Menu Image" style="width:60px;height:60px;">`;
        } else {
          imageCell.textContent = "No image";
        }
        row.querySelector('.m-name').textContent = data.name;
        row.querySelector('.m-category').textContent = data.category && data.category.name ? data.category.name : "Uncategorized";
        row.querySelector('.m-description').textContent = data.description;
        row.querySelector('.m-price').textContent = `$${data.price}`;
        menuTableBody.appendChild(row);
      }

      modal.hide();
      showAlert("Saved ✔");
    } catch (e) {
      console.error("Fetch or data error:", e);
      showAlert("Save failed ❌", false);
    }
  };

  document.addEventListener("click", async (e) => {
    if (e.target.classList.contains("edit-row")) {
      const tr = e.target.closest("tr");
      const id = tr.dataset.id;
      if (!id) {
        showAlert("Menu item id not found!", false);
        return;
      }
      const res = await fetch(API.menu + id + '/');
      if (!res.ok) {
        showAlert("Menu item not found ❌", false);
        return;
      }
      const data = await res.json();
      openModal(data);
    }

    if (e.target.classList.contains("del-row")) {
      if (!confirm("Really delete?")) return;
      const tr = e.target.closest("tr");
      const id = tr.dataset.id;
      try {
        const res = await fetch(API.menu + id + '/', {
          method: "DELETE",
          headers: {
            'X-CSRFToken': CSRF
          },
          credentials: 'same-origin'
        });
        if (!res.ok) throw Error();
        tr.remove();
        showAlert("Deleted ✔");
      } catch {
        showAlert("Delete failed ❌", false);
      }
    }
  });
</script>
{% endblock %}