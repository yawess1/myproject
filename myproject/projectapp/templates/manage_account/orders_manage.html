{% extends "base.html" %}
{% load static %}

{% block title %}Order Management{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2>Order Management</h2>
  <div class="mb-3 d-flex align-items-center">
    <label class="me-2">Filter by status:</label>
    <select id="statusFilter" class="form-select w-auto me-2">
      <option value="">All</option>
      <option value="Pending">Pending</option>
      <option value="Completed">Completed</option>
      <option value="Cancelled">Cancelled</option>
    </select>
    <button class="btn btn-primary" id="refreshBtn">Refresh</button>
  </div>
  <table class="table table-bordered align-middle">
    <thead class="table-light">
      <tr>
        <th>Order Number</th>
        <th>Order Time</th>
        <th>Table Number</th>
        <th>Items</th>
        <th>Total</th>
        <th>Status</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="orderTableBody"></tbody>
  </table>
  <div id="emptyTip" class="text-center text-muted" style="display:none;">No orders found.</div>
</div>
  
  <script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
const CSRF = getCookie('csrftoken');

    const restaurant_id = "{{ restaurant_id }}";
    const tbody = document.getElementById('orderTableBody');
    const statusFilter = document.getElementById('statusFilter');
    const emptyTip = document.getElementById('emptyTip');
    const refreshBtn = document.getElementById('refreshBtn');
  
  async function loadOrders() {
  let status = statusFilter.value;
  let url = `/myproject/api/orders/?restaurant_id=${restaurant_id}`;
  if (status) url += `&status=${status}`;
  const res = await fetch(url);
    const orders = await res.json();
    tbody.innerHTML = '';
  if (orders.length === 0) {
    emptyTip.style.display = '';
    return;
  } else {
    emptyTip.style.display = 'none';
  }
    orders.forEach(order => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${order.order_id}</td>
        <td>${order.order_time}</td>
        <td>${order.table_id}</td>
        <td>
        <ul class="mb-0">
          ${order.items.map(i => `<li>${i.menu_item_name} x ${i.quantity}</li>`).join('')}
          </ul>
        </td>
        <td>ï¿¥${order.total_cost}</td>
        <td>${order.status}</td>
        <td>
        ${order.status === 'Pending' ? 
          `<button class="btn btn-success btn-sm" onclick="finishOrder('${order.order_id}')">Complete</button>` : 
          `<span class="text-muted">-</span>`
        }
        </td>
      `;
      tbody.appendChild(tr);
    });
  }
  
  window.finishOrder = async function(order_id) {
  if (!confirm('Are you sure you want to mark this order as completed?')) return;
    const res = await fetch(`/myproject/api/orders/${order_id}/`, {
      method: 'PATCH',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': CSRF,
    },
      body: JSON.stringify({status: 'Completed'})
    });
    if (res.ok) {
    alert('Order marked as completed!');
      loadOrders();
    } else {
    alert('Operation failed, please try again.');
    }
  }
  
  statusFilter.addEventListener('change', loadOrders);
  refreshBtn.addEventListener('click', loadOrders);
  window.onload = loadOrders;
  </script>
{% endblock %}