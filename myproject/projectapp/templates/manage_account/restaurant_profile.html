{% extends "base.html" %}

{% block title %}{{ restaurant_name }} - Profile{% endblock %}

{% block content %}
<section class="py-5">
  <div class="container">

    <h2>{{ restaurant_name }} Stuff Management</h2>

    <div class="text-center mb-4">
      <blockquote class="blockquote">
        <p>{{ bio|default:"No restaurant description yet." }}</p>
        <a class="btn btn-primary btn-sm" href="{% url 'suggest_bio' user_id=user_id %}">Suggest Alternatives</a>
      </blockquote>
    </div>

    <p><strong>Contact:</strong> {{ email }}</p>
    <p><strong>Address:</strong> {{ restaurant_address }}</p>

    <div id="crudAlert" class="alert alert-dismissible fade show mt-2 d-none" role="alert">
      <span id="crudAlertMsg"></span>
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <h3>Menu Items</h3>
    <table class="table">
      <thead>
        <tr>
          <th>Name</th>
          <th>Category</th>
          <th>Description</th>
          <th>Price</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="menuTableBody">
        {% for item in menu_items %}
          <tr data-id="{{ item.id }}">
            <td class="m-name fw-semibold">{{ item.name }}</td>
            <td class="m-category">
              {% if item.category %}
                {{ item.category.name }}
              {% else %}
                Uncategorized
              {% endif %}
            </td>
            <td class="m-description">{{ item.description }}</td>
            <td class="m-price">${{ item.price }}</td>
            <td>
              <button class="btn btn-sm btn-primary me-1 edit-row">Edit</button>
              <button class="btn btn-sm btn-danger del-row">Delete</button>
            </td>
          </tr>
        {% empty %}
          <tr><td colspan="5"><em>No menu items added yet.</em></td></tr>
        {% endfor %}
      </tbody>
    </table>
    <button class="btn btn-primary w-100 mb-4" id="addMenuBtn">Add Menu Item</button>

    <div class="modal fade" id="crudModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <form id="crudForm">
            <div class="modal-header">
              <h5 class="modal-title" id="crudModalLabel">Add</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
              <div class="menu-fields">
                <div class="mb-3">
                  <label for="menuName" class="form-label fw-semibold">Dish Name</label>
                  <input type="text" class="form-control" id="menuName" name="menu_name" required>
                </div>
            </div>

              <div class="mb-3">
                <label for="menuCategory" class="form-label fw-semibold">Category</label>
                <select class="form-select" id="menuCategory" name="menu_category" required>
                  {% for cat in food_categories %}
                    <option value="{{ cat.id }}">{{ cat.name }}</option>
                  {% endfor %}
                </select>
              </div>

              <div class="mb-3">
                <label for="menuDescription" class="form-label fw-semibold">Description</label>
                <textarea class="form-control" id="menuDescription" name="menu_description" rows="2"></textarea>
              </div>

              <div class="mb-3">
                <label for="menuPrice" class="form-label fw-semibold">Price</label>
                <input type="number" step="0.01" class="form-control" id="menuPrice" name="menu_price" required>
              </div>
            </div>

            <input type="hidden" id="rowId">

            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-primary" id="saveBtn">Save</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <template id="menuRowTmpl">
      <tr>
        <td class="m-name fw-semibold"></td>
        <td class="m-category"></td>
        <td class="m-description"></td>
        <td class="m-price"></td>
        <td>
          <button class="btn btn-sm btn-primary me-1 edit-row">Edit</button>
          <button class="btn btn-sm btn-danger del-row">Delete</button>
        </td>
      </tr>
    </template>
  </div>
</section>

<script type="module">
  const API = {
    menu: '/restaurant/api/menu-items/'
  };
  const USER_ID = "{{ user_id }}";
  const CSRF = "{{ csrf_token }}";

  const modal = bootstrap.Modal.getOrCreateInstance(crudModal);

  function alertMsg(txt, ok=true) {
    crudAlertMsg.textContent = txt;
    crudAlert.classList.remove('d-none', 'alert-success', 'alert-danger');
    crudAlert.classList.add(ok ? 'alert-success' : 'alert-danger');
    setTimeout(() => crudAlert.classList.add('d-none'), 5000);
  }

  function opts(method, body = null) {
    return {
      method,
      headers: {'Content-Type': 'application/json', 'X-CSRFToken': CSRF},
      body: body ? JSON.stringify(body) : null
    };
  }

  function openModal(data = null) {
    rowId.value = data?.id ?? '';
    crudModalLabel.textContent = data ? 'Edit Menu Item' : 'Add Menu Item';
    crudForm.reset();

    if (data) {
      menuName.value = data.name;
      menuCategory.value = data.category;
      menuDescription.value = data.description ?? '';
      menuPrice.value = data.price;
    }

    modal.show();
  }

  addMenuBtn.onclick = () => openModal();

  crudForm.onsubmit = async e => {
    e.preventDefault();
    const pk = rowId.value;
    const url = pk ? API.menu + pk + '/' : API.menu;
    const method = pk ? 'PUT' : 'POST';

    const body = {
      name: menuName.value,
      category: menuCategory.value,
      description: menuDescription.value,
      price: parseFloat(menuPrice.value),
      user: USER_ID
    };

    try {
      const res = await fetch(url, opts(method, body));
      if (!res.ok) throw Error();
      const data = await res.json();

      if (pk) {
        const tr = document.querySelector(`tr[data-id="${pk}"]`);
        tr.querySelector('.m-name').textContent = data.name;
        tr.querySelector('.m-category').textContent = data.category_name;
        tr.querySelector('.m-description').textContent = data.description;
        tr.querySelector('.m-price').textContent = '$' + data.price;
      } else {
        const row = menuRowTmpl.content.cloneNode(true);
        row.firstElementChild.dataset.id = data.id;
        row.querySelector('.m-name').textContent = data.name;
        row.querySelector('.m-category').textContent = data.category_name;
        row.querySelector('.m-description').textContent = data.description;
        row.querySelector('.m-price').textContent = '$' + data.price;
        menuTableBody.appendChild(row);
      }
      modal.hide();
      alertMsg('Saved ✔');
    } catch {
      alertMsg('Save failed', false);
    }
  };

  document.addEventListener('click', async e => {
    if (e.target.classList.contains('edit-row')) {
      const tr = e.target.closest('tr');
      const id = tr.dataset.id;
      const res = await fetch(API.menu + id + '/');
      const data = await res.json();
      openModal(data);
    }

    if (e.target.classList.contains('del-row')) {
      if (!confirm('Really delete?')) return;
      const tr = e.target.closest('tr');
      const id = tr.dataset.id;
      try {
        const res = await fetch(API.menu + id + '/', opts('DELETE'));
        if (!res.ok) throw Error();
        tr.remove();
        alertMsg('Deleted ✔');
      } catch {
        alertMsg('Delete failed', false);
      }
    }
  });
</script>
{% endblock %}

