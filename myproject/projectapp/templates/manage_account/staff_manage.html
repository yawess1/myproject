{% extends "base.html" %}
{% block title %}Staff Management{% endblock %}
{% block content %}
<section class="py-5">
  <div class="container">
    <h2>{{ restaurant.name }} - Staff Management</h2>
    <div id="crudAlert" class="alert alert-dismissible fade show mt-2 d-none" role="alert">
      <span id="crudAlertMsg"></span>
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    <h3>Staff List</h3>
    <table class="table">
      <thead>
        <tr>
          <th>Username</th>
          <th>Email</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="staffTableBody">
        {% for staff in staff_list %}
        <tr data-id="{{ staff.user.id }}">
          <td>{{ staff.user.username }}</td>
          <td>{{ staff.user.email }}</td>
          <td>
            <button class="btn btn-sm btn-danger del-row">Delete</button>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="3"><em>No staff yet.</em></td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    <button class="btn btn-primary w-100 mb-4" id="addStaffBtn">Add Staff</button>

    <!-- Modal for Add Staff -->
    <div class="modal fade" id="crudModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <form id="crudForm">
            <div class="modal-header">
              <h5 class="modal-title" id="crudModalLabel">Add Staff</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label for="staffUsername" class="form-label">Username</label>
                <input type="text" class="form-control" id="staffUsername" required>
              </div>
              <div class="mb-3">
                <label for="staffEmail" class="form-label">Email</label>
                <input type="email" class="form-control" id="staffEmail" required>
              </div>
              <div class="mb-3">
                <label for="staffPassword" class="form-label">Password</label>
                <input type="password" class="form-control" id="staffPassword" required>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-primary">Save</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</section>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
const API = {
  staff: '/myproject/api/staff/',
};
const CSRF = "{{ csrf_token }}";
const RESTAURANT_ID = "{{ restaurant.id }}";
const crudModal = document.getElementById("crudModal");
const modal = new bootstrap.Modal(crudModal);

function showAlert(text, ok = true) {
  crudAlertMsg.textContent = text;
  crudAlert.classList.remove("d-none", "alert-success", "alert-danger");
  crudAlert.classList.add(ok ? "alert-success" : "alert-danger");
  setTimeout(() => crudAlert.classList.add("d-none"), 4000);
}

document.getElementById("addStaffBtn").onclick = () => {
  document.getElementById("crudForm").reset();
  document.getElementById("crudModalLabel").textContent = "Add Staff";
  modal.show();
};

crudForm.onsubmit = async (e) => {
  e.preventDefault();
  const body = {
    username: staffUsername.value,
    email: staffEmail.value,
    password: staffPassword.value,
    restaurant_id: RESTAURANT_ID
  };
  try {
    const res = await fetch(API.staff, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": CSRF,
      },
      body: JSON.stringify(body),
    });
    if (!res.ok) throw Error();
    location.reload();
  } catch {
    showAlert("Save failed ❌", false);
  }
};

document.addEventListener("click", async (e) => {
  if (e.target.classList.contains("del-row")) {
    if (!confirm("Really delete?")) return;
    const tr = e.target.closest("tr");
    const id = tr.dataset.id;
    try {
      const res = await fetch(API.staff + id + "/", {
        method: "DELETE",
        headers: {
          "X-CSRFToken": CSRF,
        },
      });
      if (!res.ok) throw Error();
      tr.remove();
      showAlert("Deleted ✔");
    } catch {
      showAlert("Delete failed ❌", false);
    }
  }
});
</script>
{% endblock %}
