{% extends "base.html" %}

{% block title %}Manage Food Categories{% endblock %}

{% block content %}
<!-- Table Management -->
<section class="py-5">
  <div class="container">
    <h2>{{ restaurant_name }} - Table Management</h2>
    <div id="crudAlert" class="alert d-none" role="alert">
      <span id="crudAlertMsg"></span>
    </div>
    <table class="table mt-4">
      <thead>
        <tr>
          <th>Name</th>
          <th>Table ID</th>
          <th>Actions</th>
          <th>QR Code</th>
        </tr>
      </thead>
      <tbody id="tableTableBody">
        {% for table in tables %}
          <tr data-id="{{ table.id }}">
            <td class="table-name fw-semibold">{{ table.name }}</td>
            <td class="table-id">{{ table.table_id }}</td>
            <td>
              <button class="btn btn-sm btn-primary me-1 edit-row">Edit</button>
              <button class="btn btn-sm btn-danger del-row">Delete</button>
            </td>
            <td>
              <img class="table-qrcode" src="/myproject/qrcode/{{ restaurant.id }}/{{ table.id }}/" alt="QR Code" width="100">
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
    <button class="btn btn-primary w-100 mb-4" id="addTableBtn">Add Table</button>

    <!-- Modal -->
    <div class="modal fade" id="crudModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <form id="crudForm">
            <div class="modal-header">
              <h5 class="modal-title" id="crudModalLabel">Add Table</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label for="tableName" class="form-label">Table Name</label>
                <input type="text" class="form-control" id="tableName" required>
              </div>
            </div>
            <input type="hidden" id="rowId">
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-primary" id="saveBtn">Save</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <template id="tableRowTmpl">
      <tr>
        <td class="table-name fw-semibold"></td>
        <td class="table-id"></td>
        <td>
          <button class="btn btn-sm btn-primary me-1 edit-row">Edit</button>
          <button class="btn btn-sm btn-danger del-row">Delete</button>
        </td>
        <td>
          <img class="table-qrcode" src="" alt="QR Code" width="100">
        </td>
      </tr>
    </template>

  </div>
</section>

<script type="module">
const API = {
  table: "/myproject/api/tables/"
};
const RESTAURANT_ID = "{{ restaurant_id }}";
const CSRF = "{{ csrf_token }}";
const modal = bootstrap.Modal.getOrCreateInstance(crudModal);

const tableName = document.getElementById("tableName");
const rowId = document.getElementById("rowId"); 

function alertMsg(txt, ok = true) {
  crudAlertMsg.textContent = txt;
  crudAlert.classList.remove("d-none", "alert-success", "alert-danger");
  crudAlert.classList.add(ok ? "alert-success" : "alert-danger");
  setTimeout(() => crudAlert.classList.add("d-none"), 4000);
}

function opts(method, body = null) {
  return {
    method,
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": CSRF,
    },
    body: body ? JSON.stringify(body) : null,
  };
}

function openModal(data = null) {
  rowId.value = data?.id ?? "";
  crudModalLabel.textContent = data ? "Edit Table" : "Add Table";
  crudForm.reset();
  if (data) {
    tableName.value = data.name;
  }
  modal.show();
}

addTableBtn.onclick = () => {
  openModal(); // 只弹窗，不直接POST
};

async function loadTables() {
  tableTableBody.innerHTML = ""; // 先清空
  const res = await fetch(API.table + `?restaurant_id=${RESTAURANT_ID}`);
  const tables = await res.json();
  tables.forEach((table) => {
    const row = tableRowTmpl.content.cloneNode(true);
    row.firstElementChild.dataset.id = table.id;
    row.querySelector(".table-name").textContent = table.name;
    row.querySelector(".table-id").textContent = table.table_id;
    const qrImg = row.querySelector(".table-qrcode");
    if (qrImg) {
      qrImg.src = `/myproject/qrcode/${RESTAURANT_ID}/${table.id}/`;
    }
    tableTableBody.appendChild(row);
  });
  console.log("RESTAURANT_ID:", RESTAURANT_ID);
}

crudForm.onsubmit = async (e) => {
  e.preventDefault();
  const pk = rowId.value;
  const url = pk ? API.table + pk + "/" : API.table;
  const method = pk ? "PUT" : "POST";

  const body = {
    name: tableName.value,
    restaurant_id: Number(RESTAURANT_ID)
  };

  try {
    const res = await fetch(url, opts(method, body));
    if (!res.ok) throw Error();
    // const data = await res.json(); // 不再直接append
    await loadTables(); // 直接刷新table列表
    modal.hide();
    alertMsg("Saved ✔");
  } catch {
    alertMsg("Save failed", false);
  }
};

document.addEventListener("click", async (e) => {
  if (e.target.classList.contains("edit-row")) {
    const tr = e.target.closest("tr");
    const id = tr.dataset.id;
    const res = await fetch(API.table + id + "/");
    const data = await res.json();
    openModal(data);
  }

  if (e.target.classList.contains("del-row")) {
    if (!confirm("Really delete?")) return;
    const tr = e.target.closest("tr");
    const id = tr.dataset.id;
    try {
      const res = await fetch(API.table + id + "/", opts("DELETE"));
      if (!res.ok) throw Error();
      await loadTables(); // 删除后刷新table列表
      alertMsg("Deleted ✔");
    } catch {
      alertMsg("Delete failed", false);
    }
  }
});

// 页面加载时加载所有table
window.onload = loadTables;
</script>
{% endblock %}